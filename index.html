<script>
    // 좌석 상태
    let seatState = [[], [], []]; // 내부 구조: [{type: 'number'|'x'|'empty', value: number|null, xLocked: bool}]
    let startNum = 1, endNum = 24, excludeNumbers = [];

    // 유틸: 숫자 섞기
    function shuffle(arr) {
        for(let i=arr.length-1;i>0;i--){
            let j = Math.floor(Math.random()*(i+1));
            [arr[i], arr[j]] = [arr[j], arr[i]];
        }
        return arr;
    }

    // 좌석 생성 함수
    function generateSeats() {
        startNum = parseInt(document.getElementById('startNum').value, 10);
        endNum = parseInt(document.getElementById('endNum').value, 10);
        // 제외 번호 파싱
        let excludeStr = document.getElementById('excludeNums').value.trim();
        excludeNumbers = excludeStr ? excludeStr.split(',').map(x => parseInt(x.trim(), 10)).filter(x => !isNaN(x)) : [];

        // 번호 목록 만들기
        let numbers = [];
        for(let i=startNum;i<=endNum;i++){
            if(!excludeNumbers.includes(i)) numbers.push(i);
        }
        let totalStudentCount = numbers.length;

        // 분단별 좌석 수 계산 (가로 2 고정)
        let divSeats = [[], [], []];
        let rowCounts = [0, 0, 0];
        let col = 2; // 항상 가로 2

        if ((endNum-startNum+1) <= 18) {
            // 18이하라면 세로(row) 3, 가로(col) 2, 6칸 * 3분단 = 18칸
            for(let i=0;i<3;i++){ 
                rowCounts[i] = 3;
                divSeats[i] = Array(rowCounts[i]*col).fill({type:'empty', value:null, xLocked:false});
            }
        } else {
            // 18 초과라면 학생수 3등분해서 각 분단에 가로 2, 세로 충분히 크게
            let totalSeats = endNum-startNum+1;
            let baseCnt = Math.floor(totalSeats/3);
            let extra = totalSeats%3;
            let seatNums = [baseCnt, baseCnt, baseCnt];
            for(let i=0;i<extra;i++) seatNums[i]++;
            for(let i=0;i<3;i++){
                rowCounts[i] = Math.ceil(seatNums[i]/col); // 가로2, 세로는 필요한 만큼
                divSeats[i] = Array(rowCounts[i]*col).fill({type:'empty', value:null, xLocked:false});
            }
        }
        // 전체 좌석 평면화
        let seatsFlat = [];
        for(let i=0;i<3;i++){
            for(let j=0;j<divSeats[i].length;j++){
                seatsFlat.push({division: i, index: j, type: 'empty', value: null, xLocked: false});
            }
        }
        // 빈칸이 더 많으면 (빈칸 수 - 학생수)만큼 x를 랜덤하게 박는다
        let needX = Math.max(0, seatsFlat.length - totalStudentCount);
        let xPosArr = [];
        if (needX>0) {
            let idxs = Array.from(Array(seatsFlat.length).keys());
            shuffle(idxs);
            xPosArr = idxs.slice(0, needX);
            for(let i=0;i<seatsFlat.length;i++){
                if(xPosArr.includes(i)){
                    seatsFlat[i].type = 'x';
                    seatsFlat[i].xLocked = false;
                }
            }
        }
        // 남은 칸에 번호 배정
        let numberArr = shuffle(numbers.slice());
        let numIdx = 0;
        for(let i=0;i<seatsFlat.length;i++){
            if(seatsFlat[i].type==='empty' && numIdx < numberArr.length){
                seatsFlat[i].type = 'number';
                seatsFlat[i].value = numberArr[numIdx++];
            }
        }
        // 다시 분단별 2차원으로 쪼개기
        let pointer = 0;
        seatState = [[],[],[]];
        for(let i=0;i<3;i++){
            for(let j=0;j<divSeats[i].length;j++){
                seatState[i][j] = seatsFlat[pointer++];
            }
        }
        renderSeats();
    }

    // 좌석 렌더링 함수
    function renderSeats() {
        const seatingArea = document.getElementById('seatingArea');
        seatingArea.innerHTML = '';
        for(let d=0;d<3;d++){
            let div = document.createElement('div');
            div.className = 'division';
            let title = document.createElement('div');
            title.className = 'division-title';
            title.textContent = `${d+1}분단`;
            div.appendChild(title);

            // 가로 2 고정, 세로는 좌석 수/2 올림
            let seatLen = seatState[d].length;
            let col = 2;
            let row = Math.ceil(seatLen/col);

            let grid = document.createElement('div');
            grid.className = 'seats-grid';
            grid.style.gridTemplateColumns = `repeat(${col}, 1fr)`;
            grid.style.gridTemplateRows = `repeat(${row}, 1fr)`;

            for(let i=0;i<seatLen;i++){
                let seat = seatState[d][i];
                let seatDiv = document.createElement('div');
                seatDiv.className = 'seat';
                if(seat.type==='number'){
                    seatDiv.textContent = seat.value;
                } else if(seat.type==='x'){
                    seatDiv.textContent = 'X';
                    seatDiv.classList.add('x-seat');
                } else {
                    seatDiv.classList.add('empty');
                    seatDiv.textContent = '';
                }
                seatDiv.dataset.division = d;
                seatDiv.dataset.index = i;
                seatDiv.addEventListener('click', handleSeatClick);
                grid.appendChild(seatDiv);
            }
            div.appendChild(grid);
            seatingArea.appendChild(div);
        }
    }

    // 좌석 클릭 핸들러 (좌석에 X 표시, X 유지, X 좌석은 무효)
    function handleSeatClick(e) {
        let div = parseInt(this.dataset.division,10);
        let idx = parseInt(this.dataset.index,10);
        let seat = seatState[div][idx];

        // 이미 X면 X 해제, 아니면 X로 변경(단, 숫자이면 X 못 함)
        if(seat.type === 'number') return;
        if(seat.type === 'x') {
            seatState[div][idx].type = 'empty';
            seatState[div][idx].xLocked = false;
        } else if(seat.type === 'empty') {
            seatState[div][idx].type = 'x';
            seatState[div][idx].xLocked = true;
        }
        renderSeats();
    }

    // 자리 다시 뽑기시 X는 유지, X가 있는칸에 숫자 안배정
    function replaySeats() {
        // xLocked = true인 칸은 X로 유지
        let numbers = [];
        for(let i=startNum;i<=endNum;i++){
            if(!excludeNumbers.includes(i)) numbers.push(i);
        }
        let numberArr = shuffle(numbers.slice());
        let numIdx = 0;
        for(let d=0;d<3;d++){
            for(let i=0;i<seatState[d].length;i++){
                let seat = seatState[d][i];
                if(seat.type==='x' && seat.xLocked) continue;
                if(numIdx < numberArr.length){
                    seatState[d][i].type = 'number';
                    seatState[d][i].value = numberArr[numIdx++];
                    seatState[d][i].xLocked = false;
                } else {
                    seatState[d][i].type = 'empty';
                    seatState[d][i].value = null;
                    seatState[d][i].xLocked = false;
                }
            }
        }
        // xLocked 칸은 x로 표시
        for(let d=0;d<3;d++){
            for(let i=0;i<seatState[d].length;i++){
                if(seatState[d][i].xLocked){
                    seatState[d][i].type = 'x';
                    seatState[d][i].value = null;
                }
            }
        }
        renderSeats();
    }

    document.getElementById('generateBtn').addEventListener('click',function(){
        generateSeats();
        // 자리뽑기 버튼이 자리 다시뽑기로 변경
        this.textContent = "자리 다시 뽑기";
        this.onclick = replaySeats;
    });

    // 최초 1회 자동 렌더
    window.onload = generateSeats;
</script>
